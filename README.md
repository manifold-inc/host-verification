# Host Verification Tool

A command-line tool for verifying host system capabilities for confidential computing on Ubuntu Linux.

## Features

The Host Verification Tool performs the following checks:

- **CPU Capabilities**: Verifies CPU features required for confidential computing (AMD SEV, SEV-ES, SEV-SNP, Intel TDX)
- **TPM Status**: Confirms TPM 2.0 presence and configuration
- **Secure Boot**: Checks UEFI Secure Boot status (recommended but not required)
- **OS Support**: Checks kernel version and required modules
- **BIOS/Firmware**: Retrieves firmware information
- **Intel TDX BIOS Settings**: Checks for evidence of required BIOS settings for TDX:
  - Memory Encryption (TME) = Enable (Required)
  - Total Memory Encryption Bypass = Enable (Optional - for better host OS and regular VM performance)
  - Total Memory Encryption Multi-Tenant (TME-MT) = Enable (Required)
  - TME-MT memory integrity = Disable (Required)
  - Trust Domain Extension (TDX) = Enable (Required)
  - TDX Secure Arbitration Mode Loader (SEAM Loader) = Enable (Required)
  - TME-MT/TDX key split = Non-zero value (Required)
  - Software Guard Extensions (SGX) = Enable (Recommended)
- **Security Vulnerabilities**: Checks for CPU vulnerabilities and their mitigations
- **Hardware ID**: Generates a unique hardware identifier
- **System Hardware**: Collects detailed hardware inventory (RAM, disk space, CPU cores, network interfaces)
- **JSON Reporting**: Generates detailed JSON reports with scoring and grading
- **Attestation Service Integration**: Submits reports to the attestation service and processes responses
- **VM Download**: Downloads VM files generated by the attestation service (when using `--submit`)

## Quick Start

```bash
git clone https://github.com/manifold-inc/host-verification.git
cd host-verification
chmod +x bin/host-verification
./bin/host-verification
```


## Implementation Details


### TDX BIOS Verification

The tool uses multiple methods to verify Intel TDX BIOS settings:

1. **Direct MSR Reading**: Uses `rdmsr` tool to read Model-Specific Registers that control TDX features:
   - MSR 0x982 (IA32_TME_ACTIVATE) - Controls TME, TME Bypass, TME-MT memory integrity, and key split
   - MSR 0x1105 (IA32_TDX_ATTR) - Contains TDX and SEAM Loader enablement status
   - Requires root privileges and the `msr-tools` package
   - Includes graceful fallback if `rdmsr` is unavailable

2. **Kernel Logs Analysis**: Examines kernel logs for evidence of:
   - TDX module initialisation
   - TME enablement messages
   - SEAM Loader references

3. **Device Files & Sysfs**: Checks for:
   - `/dev/tdx_guest` device file
   - TDX-related entries in `/sys/devices/`
   - SGX device files

These multi-layered verification methods ensure reliable detection of TDX settings even when some approaches are unavailable.

## Implementation Status

| Feature                     | Status        | Details                                          |
|-----------------------------|---------------|--------------------------------------------------|
| CPU Verification            | ✅ Implemented | Complete with vendor-specific checks (AMD/Intel) |
| TPM Verification            | ✅ Implemented | Device presence, manufacturer, firmware version  |
| Secure Boot Check           | ✅ Implemented | UEFI mode, Secure Boot status (recommended)      |
| OS Support Check            | ✅ Implemented | Kernel version, modules, distribution detection  |
| BIOS Information            | ✅ Implemented | Vendor, version, release date, system details    |
| Intel TDX BIOS Verification | ✅ Implemented | MSR reading, kernel log analysis, device checks  |
| Security Vulnerabilities    | ✅ Implemented | CPU vulnerabilities and kernel mitigations       |
| Hardware ID Generation      | ✅ Implemented | Composite hardware ID from multiple sources      |
| Package Verification        | ✅ Implemented | Required and optional package detection          |
| System Hardware Inventory   | ✅ Implemented | RAM, disk, CPU cores, network interfaces         |
| JSON Reporting              | ✅ Implemented | Detailed reports with grading and metadata       |
| WSL Detection               | ✅ Implemented | With clear limitations messaging                 |
| Multi-distro Support        | ✅ Implemented | Auto-detection of package managers               |
| API Integration             | ✅ Implemented | Uses ManifoldSDK for attestation service API     |
| Attestation                 | ✅ Implemented | Submit reports and process responses             |
| VM Status Monitoring        | ✅ Implemented | Real-time tracking of VM generation progress     |
| VM Download                 | ✅ Implemented | Downloads simulated VM files with progress bar   |

## Requirements

### System Requirements

- Linux (bare metal installation, multiple distributions supported)
- Root privileges (for hardware access and MSR reading)
- x86_64 architecture

### Required Packages

The following packages are required for full functionality:

- `dmidecode`: For hardware information gathering
- `mokutil`: For Secure Boot status checking
- `tpm2-tools`: For TPM verification
- `msr-tools`: For MSR access (critically required for Intel TDX BIOS verification)

### Package Installation

The tool automatically detects the system's package manager and installs dependencies as needed. Supported package managers include:

- APT (Debian, Ubuntu)
- YUM (CentOS, RHEL)
- DNF (Fedora)
- Pacman (Arch, Manjaro)
- Zypper (SUSE, openSUSE)

Manual installation commands for various distributions:

```bash
# For Ubuntu/Debian
sudo apt-get update
sudo apt-get install dmidecode mokutil tpm2-tools msr-tools

# For Fedora
sudo dnf install dmidecode mokutil tpm2-tools msr-tools

# For RHEL/CentOS
sudo yum install dmidecode mokutil tpm2-tools msr-tools
```

### Hardware Support

The tool provides specific checks based on your CPU vendor:

- **AMD CPUs**: Checks for SEV, SEV-ES, and SEV-SNP capabilities and required kernel modules (kvm_amd, ccp, sev)
- **Intel CPUs**: Checks for TDX capabilities, required BIOS settings, and kernel modules (kvm_intel, intel_iommu)

### MSR Access Requirements

For Intel TDX BIOS verification, the tool requires:

1. The `msr-tools` package installed (verified during dependency checking)
2. Root privileges to execute `rdmsr` commands
3. The `msr` kernel module loaded (`modprobe msr`)
4. Bare metal system (not virtualised) for direct hardware access

If the `rdmsr` command is not available, the tool will:
1. Provide clear warning messages about limited TDX verification capabilities
2. Fall back to alternative verification methods through kernel logs and device checks
3. Continue with all other verification functions without interruption
4. Recommend installation of the `msr-tools` package

## Usage

### Building from Source

```bash
# Clone the repository
git clone https://github.com/yourusername/host-verification.git
cd host-verification

# Build the binary using provided scripts
# On Linux/macOS:
./build-linux.sh

# On Windows (PowerShell):
.\build-linux.ps1
```

### Running the Tool

```bash
# Run with root privileges for full functionality
sudo ./host-verification

# Generate a JSON report
sudo ./host-verification --json

# Save JSON report to a specific file
sudo ./host-verification --json --output report.json

# Show version information
./host-verification --version

# Display compact output (only failed checks and summaries)
sudo ./host-verification --compact

# Submit report to the attestation service (requires an API key)
sudo ./host-verification --submit 

# Submit report with a custom service URL (API key is still required)
sudo ./host-verification --submit --service-url https://attestation.example.com
```

The tool will automatically:
1. Check for required dependencies and offer to install them with the appropriate package manager
2. Verify CPU capabilities for confidential computing
3. Check TPM 2.0 status
4. Verify Secure Boot configuration
5. Validate OS support for confidential computing
6. Display BIOS/firmware information
7. Check Intel TDX BIOS settings (if applicable)
8. Check for security vulnerabilities and mitigations
9. Collect system hardware information
10. Generate a unique hardware identifier
11. Create a JSON report if requested
12. Submit the report to the attestation service if requested
13. Download VM files if generated by the attestation service

### Report Submission

When using the `--submit` flag, the tool will:

1. Perform all verification checks
2. Generate a report with system details and verification results
3. Send the report to the attestation service specified by `--service-url` (defaults to http://localhost:8081)
4. Display the attestation decision returned by the service
5. If the attestation is valid, monitor and download VM files generated by the service

Example usage:
```bash
# Submit report to the default attestation service
sudo ./host-verification --submit

# Submit to a custom attestation service with authentication
sudo ./host-verification --submit --service-url https://attestation.example.com
```

This allows for automated attestation workflows where systems can be verified and their attestation status determined in a single command.

### Confidential VM Download

When the attestation service initiates VM generation after a successful report submission, the tool will:

1. Monitor the VM generation process with a real-time progress bar
2. Display estimated time remaining and generation status
3. Automatically download the VM file when ready
4. Save the VM to the user's home directory under `~/manifold-vms/`
5. Show download progress with speed and file size information

This functionality is enabled automatically when using the `--submit` flag and requires no additional configuration.

**Note on Current Implementation**: In the current development version, the attestation service generates and returns simulated VM files (approximately 500MB dummy files) rather than actual functional confidential VMs. This is implemented for testing and demonstration purposes. The download workflow and progress tracking are fully functional, but the VM files themselves are simulated placeholders. In future versions, this will be replaced with actual confidential VM generation capabilities.

## Understanding TDX Verification Results

The Host Verification tool provides detailed feedback on Intel TDX BIOS settings:

| Check                   | Required     | Description                                           |
|-------------------------|--------------|-------------------------------------------------------|
| TME                     | Required     | Total Memory Encryption must be enabled               |
| TME Bypass              | Optional     | Enables better performance for non-TDX workloads      |
| TME-MT                  | Required     | Multi-tenant encryption must be enabled               |
| TME-MT memory integrity | Required OFF | Must be disabled for TDX operation                    |
| TDX                     | Required     | Trust Domain Extensions must be enabled               |
| SEAM Loader             | Required     | Required to load Intel TDX module                     |
| Key Split               | Required     | Must be non-zero for proper isolation                 |
| SGX                     | Recommended  | Software Guard Extensions provide additional security |

For TDX systems, all required settings must be correctly configured for proper TDX operation. The tool will provide specific recommendations for any settings that need adjustment.

**Note**: Secure Boot is a system-wide recommendation that enhances overall system security, but it is not specifically required for TDX or SEV operation.

## JSON Reporting

The tool generates comprehensive JSON reports with detailed information about each verification check. Reports include:

- Overall system status and grade
- Individual section scores and grades
- Detailed check results with metadata
- Recommendations for failed or warning checks
- Hardware identification information

When generating a JSON report with the `--json` flag, the tool will:
- If `--output` is specified: Save the report to the specified file path
- If no `--output` is specified: Save to `$HOME/.host-verification/reports/` or fall back to `./reports/`

The report filename follows the format: `host-verification-[hostname]-[timestamp].json`

Example report structure:
```json
{
  "hardware_id": "a1b2c3d4e5f6...",
  "hostname": "example-host",
  "timestamp": "2023-03-17T12:34:56Z",
  "overall_status": "pass",
  "overall_grade": 92.5,
  "sections": [
    {
      "name": "cpu_capabilities",
      "description": "CPU capabilities for confidential computing",
      "checks": [
        {
          "name": "sev_support",
          "status": "pass",
          "message": "AMD SEV supported",
          "metadata": {
            "sev_support": true,
            "sev_es_support": true,
            "sev_snp_support": false,
            "recommendation": "Upgrade firmware for SEV-SNP support"
          }
        }
      ],
      "total_points": 3,
      "passed_points": 3,
      "grade": 100.0
    }
  ],
  "metadata": {
    "version": "1.0.0",
    "timestamp": "2023-03-17T12:34:56Z"
  }
}
```

## Security Vulnerability Checking

The tool checks for known CPU vulnerabilities and their mitigations, including:

- Spectre variants (v1, v2, BHB, RSR)
- Meltdown
- L1 Terminal Fault
- Micro-architectural Data Sampling (MDS)
- Special Register Buffer Data Sampling (SRBDS)
- Retbleed
- Other side-channel vulnerabilities

It also verifies kernel security features such as:
- SMT/Hyperthreading status
- Kernel Page Table Isolation (KPTI)
- IOMMU enablement
- CPU microcode updates

For each vulnerability, the tool provides mitigation status and recommendations if issues are found.

## Hardware ID Generation

The tool generates a unique hardware identifier using multiple sources:

1. **Product UUID**: Uses the system UUID via `dmidecode` (requires `dmidecode` and root privileges)
2. **Composite Hardware ID**: Creates a hash from:
   - CPU model and microcode
   - Motherboard serial number
   - Memory module serials
   - Storage device serials
   - MAC addresses
   - TPM identifiers
   - PCI device IDs

The hardware ID can be used to uniquely identify the system for attestation purposes.

## System Hardware Information

The tool collects detailed system hardware information:

- **Memory**: Total RAM and available memory
- **Disk Storage**: Root disk space usage and list of all physical disks with sizes
- **CPU**: Physical core count and thread count
- **Network**: Network interfaces, MAC addresses, and IP configurations

This information is useful for:
- System inventory management
- Performance assessment 
- Resource requirement verification
- Network configuration auditing

All hardware information is collected in a structured format that can be output as JSON or displayed in the console.

**Note**: The System Hardware Information section is purely informational. All checks in this section are marked with "info" status and do not count towards the system's compliance grade.

## Virtualisation Limitations

While the tool can run in virtualised environments (VMs, containers, WSL), some functionality will be limited:

- **MSR access**: Direct MSR reading won't work in most virtualised environments
- **BIOS settings**: Can't be directly verified in virtualised environments
- **Hardware ID**: May be less reliable in virtualised environments
- **TPM access**: May be unavailable or limited in virtualised environments
- **Kernel modules**: Some modules may not be available or loadable

For complete TDX/SEV verification, the tool should be run on bare metal hardware.

## Enhanced Console Output

The tool provides detailed console output with:

- Colour-coded results (pass, fail, warning, info)
- Progress bars for each section
- Grading indicators
- Specific recommendations for failed checks
- Action items summary
- Compatibility warnings for virtualised environments

## License

This project is licensed under the MIT License - see the LICENSE file for details.